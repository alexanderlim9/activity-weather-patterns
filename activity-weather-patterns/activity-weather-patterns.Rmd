---
title: "R Notebook"
output: html_notebook
---
Objective: Determine trends in activity patterns with respect to both weather and routine to predict and inform/improve future behavior.

Install packages.
```{r}
devtools::install_github("avsecz/fitbitr")
devtools::install_github("r-lib/httr#485")
install.packages("jsonlite")
install.packages("mongolite")
install.packages("lubridate")
install.packages("RCurl")
install.packages("XML")
install.packages("ggplot2")
```
Load packages.
```{r}
library("fitbitr")
library("httr")  
library("jsonlite")
library("mongolite")
library("lubridate")
library("RCurl")
library("XML")
library("ggplot2")
token <- get_fitbit_token()
```

Pull raw activity data (JSON) from Fitbit API from 2016-06-23 (when I first began wearing the fitbit) to present.
```{r}
req <-
fitbit_GET("1/user/4QXD3G/activities/steps/date/2016-06-23/2017-12-02.json",
token = token)

output <- toJSON(fitbit_parse(req))
output
# ts <- ts(rev(output$sleep$minutesAsleep), start=c(1, 1), end=c(19, 1), frequency=1)
```
Convert JSON to data frame.
```{r}
output <- fromJSON(output, simplifyDataFrame = TRUE)
output
```
Clean activity data. Unlist JSON elements into columns. Convert data types and rename value column.
```{r}
data <- output$`activities-steps`
data$dateTime <- unlist(data$dateTime)
data$stepCount <- unlist(data$stepCount)
data

colnames(data)[2] <- "stepCount"
data$dateTime <- as.Date(data$dateTime, "%Y-%m-%d")
data$stepCount <- as.integer(data$stepCount)
```

Add additional date information features for day of the week and number week of the year.
```{r}
day <- weekdays(data$dateTime)
week <- week(data$dateTime)
data <- cbind(data, day, week)
data
```
Histogram representing distribution of daily step counts. The histogram shows a normal distribution.
```{r}
qplot(data$stepCount,
      geom="histogram",
      binwidth=500)
```

Create function to scrape weather data from https://www.wunderground.com/ for a given time period.
(The source is unable to provide history for very large periods of time and therefore must be retrieved in batches).
```{r}
getUrl <- function (date1, date2) {
  # Assemble proper url to retrieve weather data from webpage.
  # Arguments: date1, date2 are strings representing the start and end date in the format 'YYYY/mm/dd'
  # Returns: the customized url

  URL <-
  paste(
  "https://www.wunderground.com/history/airport/KBOS/",
  date1,
  "/CustomHistory.html?dayend=",
  substr(date2, 9, 10),
  "&monthend=",
  substr(date2, 6, 7),
  "&yearend=",
  substr(date2, 1, 4),
  "&req_city=&req_state=&req_statename=&reqdb.zip=&reqdb.magic=&reqdb.wmo=",
  sep = ""
  )
  return (URL)
}

fetchWeather <- function(startDate, endDate) {
  # Retrieve weather data for a given date range from webpage.
  # Arguments: startDate, endDate are strings representing the start and end date in the format 'YYYY/mm/dd'
  # Returns: a data frame containing the date, temperature, humidity, wind, precipitation, and types of weather

  webpage <-
    RCurl::getURL(getUrl(startDate, endDate))
  tc <- textConnection(webpage)
  webpage <- readLines(tc)
  close(tc)

  pagetree <- htmlTreeParse(webpage, useInternalNodes = TRUE)
  weatherDate <-
  unlist(xpathApply(pagetree, "//*[@id='obsTable']/tbody/tr/td[1]/a", xmlValue))

  weatherTempHi <-
  unlist(xpathApply(
  pagetree,
  "//*[@id='obsTable']/tbody/tr/td[2]/span",
  xmlValue
  ))

  weatherTempLo <-
  unlist(xpathApply(
  pagetree,
  "//*[@id='obsTable']/tbody/tr/td[4]/span",
  xmlValue
  ))

  weatherHumidity <-
  unlist(xpathApply(
  pagetree,
  "//*[@id='obsTable']/tbody/tr/td[9]/span",
  xmlValue
  ))

  weatherWind <-
  unlist(xpathApply(
  pagetree,
  "//*[@id='obsTable']/tbody/tr/td[18]/span",
  xmlValue
  ))

  weatherPrecip <-
  unlist(xpathApply(
  pagetree,
  "//*[@id='obsTable']/tbody/tr/td[20]/span",
  xmlValue
  ))

  weatherType <-
  unlist(xpathApply(pagetree, "//*[@id='obsTable']/tbody/tr/td[21]", xmlValue))

  # cleaning
  weatherType <-
  weatherType[grepl("\n", weatherType)] # remove empty strings
  weatherType <- gsub("\n", "", weatherType)
  weatherType <- gsub("\t", "", weatherType)

  weatherType
  weatherRain <- grepl("Rain", weatherType)
  weatherThunder <- grepl("Thunderstorm", weatherType)
  weatherFog <- grepl("Fog", weatherType)
  weatherSnow <- grepl("Snow", weatherType)

  weatherFrame <-
  data.frame(
  weatherDate,
  weatherTempHi,
  weatherTempLo,
  weatherHumidity,
  weatherWind,
  weatherPrecip,
  weatherType,
  weatherRain,
  weatherThunder,
  weatherFog,
  weatherSnow,
  stringsAsFactors = FALSE)

  weatherFrame[, 1:6] <- sapply(weatherFrame[, 1:6], as.numeric)

  colnames(weatherFrame) <-
  c("date",
  "tempHi",
  "tempLo",
  "avgHumidity",
  "avgWind",
  "precip",
  "type",
  "rain",
  "thunder",
  "fog",
  "snow")

  return(weatherFrame)
}

weather2016 <- fetchWeather("2016/06/23", "2017/06/22")
weather2017 <- fetchWeather("2017/06/23", "2017/12/02")
weatherTotal <- rbind(weather2016, weather2017)
weatherTotal
```

Only the precipitation column contains missing values.
```{r}
sapply(weatherTotal[,1:11], function(x) length(x[which(is.na(x) == TRUE)]))
```

Exploratory visuals for precipitation.
```{r}
# precipitation over a one year period
plot(weather2016$precip, xlab="days since 2016/06/23", ylab="precipitation (in)")
# distribution of precipitation amounts
qplot(weatherTotal$precip,
      geom="histogram")
# distribution of non-zero precipitation amounts
qplot(weatherTotal$precip[which(weatherTotal$precip>0)],
      geom="histogram")
```

Create regression model to impute missing precipitation data.
```{r}
# pred <- lm(
#   weatherTotal$precip ~
#   weatherDate +
#   weatherTotal$weatherTempHi +
#   weatherTotal$weatherTempLo +
#   weatherTotal$weatherHumidity +
#   weatherTotal$weatherWind +
#   weatherTotal$weatherType +
#   weatherTotal$weatherRain +
#   weatherTotal$weatherThunder +
#   weatherTotal$weatherFog +
#   weatherTotal$weatherSnow,
#   df
#   )
# 
# 
# 
# pred <- lm(Salary ~ Exp + Level, df)
# 
# summary(pred)

```







